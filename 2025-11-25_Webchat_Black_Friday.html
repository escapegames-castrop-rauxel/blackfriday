<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>Escape Game Castrop-Rauxel R√§tsel-Bot</title>
<style>
:root{
    --primary: #007bff;
    --primary-dark: #0056b3;
    --accent: #f7b731;
}

/* Body & Hintergrund */
html,body{
    height:100%;
    margin:0;
    font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color:#111;
}
body {
    display:flex;
    justify-content:center;
    align-items:flex-start; /* Chat h√∂her positioniert */
    padding-top: 40px; /* Abstand von oben */
    background: #111 url('2025-11-09_Hintergrund_Webchat_Der_stille_Riese.png') no-repeat center top;
    background-size: cover;
    min-height: 100vh;
    position: relative;
}

/* Countdown */
#countdown {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.55);
    padding: 8px 12px;
    border-radius: 10px;
    color: var(--accent);
    font-size: 1.1rem;
    font-weight: 700;
    border: 2px solid rgba(247,183,49,0.22);
    text-shadow: 0 0 6px rgba(0,0,0,0.6);
    z-index: 10;
    font-family: 'Courier New', monospace;
}

/* Chat Wrapper */
.chat-wrapper {
    width: 95%;
    max-width: 420px;
    height: 75vh;
    max-height: 720px;
    background: rgba(255,255,255,0.25); /* transparenter */
    backdrop-filter: blur(10px);
    border-radius: 14px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.5);
    display:flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
    z-index: 5;
}

/* Chat Container */
.chat-container {
    flex:1;
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:8px;
    overflow-y:auto;
    -webkit-overflow-scrolling: touch;
}

/* Messages */
.message { display:flex; align-items:flex-end; gap:10px; margin:6px 0; }
.text-bubble {
    padding:10px 14px;
    border-radius:16px;
    font-size:0.95rem;
    line-height:1.4;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    word-break: break-word;
}

.bot-msg { justify-content:flex-start; }
.bot-avatar {
    width:40px; height:40px; border-radius:50%; object-fit:cover;
    flex-shrink:0; box-shadow:0 1px 4px rgba(0,0,0,0.25);
}
.bot-bubble { background: rgba(255,255,255,0.8); border-top-left-radius:4px; max-width:78%; }

.user-msg { justify-content:flex-end; }
.user-bubble {
    background: linear-gradient(180deg,var(--primary),var(--primary-dark));
    color:white; border-top-right-radius:4px;
    max-width:75%; word-break: break-word;
}

/* Typing Indicator */
.typing-wrapper { display:flex; gap:10px; align-items:center; }
.typing-avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; opacity:0.9; }
.typing-bubble { width:64px; padding:8px 10px; border-radius:14px;
    background:rgba(255,255,255,0.85); display:flex; align-items:center; justify-content:center; }
.dot { width:7px;height:7px;border-radius:50%;background:#777;margin:0 2px;opacity:0.3;
      animation: dot 1s infinite; }
.dot:nth-child(2){animation-delay:0.15s}
.dot:nth-child(3){animation-delay:0.3s}
@keyframes dot {
    0%{opacity:0.25; transform: translateY(0);}
    50%{opacity:1; transform: translateY(-4px);}
    100%{opacity:0.25; transform: translateY(0);}
}

/* Input */
.input-container {
    display:flex; align-items:center; gap:10px;
    padding:12px; border-top:1px solid rgba(0,0,0,0.06);
    background: rgba(255,255,255,0.35);
    backdrop-filter: blur(10px);
}

.input-container form { display:flex; flex:1; gap:10px; align-items:center; }
input[type="text"]{
    flex:1; padding:11px 14px; border-radius:24px; border:1px solid rgba(0,0,0,0.12);
    outline:none; font-size:1rem; background:white;
}
input[type="text"]:disabled { background:#f3f3f3; color:#888; }
button[type="submit"]{
    padding:10px 16px; border-radius:20px; border:none;
    background: var(--primary); color:white; font-weight:700; cursor:pointer;
}
button[type="submit"]:disabled{ opacity:0.6; cursor:default; }

/* Start Button */
.start-btn {
    margin-top:10px; padding:8px 14px; border-radius:18px;
    border:none; background:#28a745; color:white; font-weight:700; cursor:pointer;
}
.start-btn:active { transform: translateY(1px); }

/* Mobile tweaks */
@media (max-width:420px){
    .chat-wrapper { height: 70vh; max-width: 380px; margin-top:20px; } /* h√∂her auf Mobile */
    #countdown { top:10px; right:10px; font-size:1rem; padding:6px 10px; }
}
</style>
</head>
<body>

<div id="countdown">02:00</div>

<div class="chat-wrapper" role="application" aria-label="R√§tsel Chat">
    <div class="chat-container" id="chat" aria-live="polite">
        <div class="message bot-msg" id="welcomeMsg">
            <img src="2025-11-16_Avatar_Chatbot.png" alt="Bot" class="bot-avatar" />
            <div class="text-bubble bot-bubble" id="welcomeBubble">
                <div style="font-weight:600;margin-bottom:6px;">Willkommen, Abenteurer! üîç</div>
                <div style="margin-bottom:6px;">Ich bin der R√§tsel-Bot von Escape Game Castrop-Rauxel. Bist du bereit?</div>
                <div><strong>üëâ Antworte mit START</strong></div>
                <button class="start-btn" id="startBtn" aria-label="Start R√§tsel">START</button>
            </div>
        </div>
    </div>

    <div class="input-container">
        <form id="chatForm" autocomplete="off">
            <input id="userInput" type="text" placeholder="Deine Antwort..." aria-label="Antwort eingeben" />
            <button id="sendBtn" type="submit">Senden</button>
        </form>
    </div>
</div>

<audio id="startSound" src="2025-11-09_Soundeffekt_Der_stille_Riese.mp3" preload="auto"></audio>

<script>
const chat = document.getElementById('chat');
const chatForm = document.getElementById('chatForm');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const startBtn = document.getElementById('startBtn');
const startSound = document.getElementById('startSound');

let gameState='WAIT_START', timer=null, remaining=120, timerRunning=false, expiredHandled=false;

function scrollToBottom(){ chat.scrollTop = chat.scrollHeight; }

function addBotMessage(html){
    const wrapper=document.createElement('div');
    wrapper.className='message bot-msg';
    wrapper.innerHTML=`<img src="2025-11-16_Avatar_Chatbot.png" alt="Bot" class="bot-avatar"><div class="text-bubble bot-bubble">${html}</div>`;
    chat.appendChild(wrapper); scrollToBottom();
}

function addUserMessage(text){
    const wrapper=document.createElement('div');
    wrapper.className='message user-msg';
    const bubble=document.createElement('div');
    bubble.className='text-bubble user-bubble'; bubble.textContent=text;
    wrapper.appendChild(bubble);
    chat.appendChild(wrapper);
    scrollToBottom();
}

function showTypingIndicator(){
    const wrapper=document.createElement('div');
    wrapper.className='message bot-msg typing-wrapper';
    wrapper.innerHTML=`<img src="2025-11-16_Avatar_Chatbot.png" alt="Bot" class="typing-avatar"><div class="typing-bubble"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
    chat.appendChild(wrapper); scrollToBottom();
    return ()=>{ wrapper.remove(); };
}

function botReply(html){
    const plain=html.replace(/<[^>]*>/g,''); const delay=Math.min(4500,700+25*plain.length);
    const removeTyping=showTypingIndicator();
    return new Promise(resolve=>{
        setTimeout(()=>{ removeTyping(); addBotMessage(html); resolve(); },delay);
    });
}

function updateCountdownUI(){ document.getElementById('countdown').textContent = `${String(Math.floor(remaining/60)).padStart(2,'0')}:${String(remaining%60).padStart(2,'0')}`; }
function startTimer(){ if(timerRunning) return; timerRunning=true; remaining=120; updateCountdownUI(); timer=setInterval(()=>{ remaining--; updateCountdownUI(); if(remaining<=0){ clearInterval(timer); timerRunning=false; handleExpired(); }},1000); }
function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } timerRunning=false; }

function handleExpired(){ if(expiredHandled) return; expiredHandled=true; gameState='EXPIRED'; userInput.disabled=true; sendBtn.disabled=true; botReply('Deine R√§tselzeit ist leider abgelaufen.'); }

startBtn.addEventListener('click', ()=>{
    addUserMessage('START');
    // Audio nur √ºber Klick (iOS erlaubt)
    startSound.currentTime=0; startSound.play().catch(()=>{console.warn('Audio blockiert');});
    startBtn.remove();
    startTimer(); gameState='WAIT_ANSWER';
    botReply(`Sehr gut! üß≠<br>
        Du stehst auf dem Marktplatz von Castrop.<br>
        Ein alter Stadtf√ºhrer fl√ºstert dir zu:<br>
        <em>Ich sah das Dunkel, Tag f√ºr Tag,<br>wo keiner Sonne finden mag.<br>
        Die Stadt, sie wuchs durch meinen Flei√ü,<br>doch Ruhm vergeht ‚Äì wie Staub so leis.<br>
        Nun steh‚Äô ich still, aus Stahl gemacht,<br>bewacht die Stadt bei Tag und Nacht.</em><br>
        Wer bin ich? ü§î<br>
        (Antworte mit dem Ort!)<br>
        Wenn du einen Tipp ben√∂tigst schreibe <strong>HILFE</strong>.`);
});

chatForm.addEventListener('submit',(e)=>{
    e.preventDefault();
    if(gameState==='EXPIRED'||userInput.disabled) return;
    const raw=userInput.value.trim(); if(!raw) return; userInput.value='';
    addUserMessage(raw); handleInput(raw.toUpperCase());
});

function handleInput(input){
    if(gameState==='WAIT_START'){ if(input==='START'){ startBtn.click(); } else { botReply('Bitte antworte mit <strong>START</strong>!'); } return; }
    if(gameState==='WAIT_ANSWER'){
        if(input==='HILFE'){ botReply('üí° Ein stilles Denkmal des Bergbaus.'); return; }
        const normalized=input.replace(/\s+/g,'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase();
        if(normalized.includes('ZECH') && normalized.includes('ERIN')){ stopTimer(); botReply(`Ganz genau! üéâ<br>
            Der Geist der Zeche Erin wacht noch immer √ºber Castrop!<br><br>
            üëâ Mehr unter <a href="https://www.escapegame-castrop-rauxel.de/" target="_blank">escapegame-castrop-rauxel.de</a>`).then(()=>{ gameState='FINISHED'; }); return; }
        botReply('Denk nochmal nach! üòä');
    }
}

userInput.focus();
updateCountdownUI();
</script>
</body>
</html>
