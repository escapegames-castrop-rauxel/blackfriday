<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Escape Game Castrop-Rauxel R√§tsel-Bot</title>
<style>
    :root{
        --primary: #007bff;
        --primary-dark: #0056b3;
        --accent: #f7b731;
        --glass: rgba(255,255,255,0.55);
    }

    html,body{height:100%;margin:0;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background-color:#111;}

    body {
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background: url('2025-11-09_Hintergrund_Webchat_Der_stille_Riese.png') no-repeat center center fixed;
        background-size: cover;
        height: 100vh;
        position: relative;
    }

    /* Countdown oben rechts im Hintergrund */
    #countdown {
        position: absolute;
        top: 18px;
        right: 18px;
        background: rgba(0,0,0,0.55);
        padding: 10px 14px;
        border-radius: 10px;
        color: var(--accent);
        font-size: 1.1rem;
        font-weight: 700;
        border: 2px solid rgba(247,183,49,0.22);
        text-shadow: 0 0 6px rgba(0,0,0,0.6);
        z-index: 2;
        font-family: 'Courier New', monospace;
    }

    /* Chatwrapper (zentriert, transparent) */
    .chat-wrapper {
        width: 95%;
        max-width: 420px;
        height: 78vh;
        max-height: 760px;
        background: rgba(255,255,255,0.48); /* transparenter */
        backdrop-filter: blur(6px);
        border-radius: 14px;
        box-shadow: 0 12px 40px rgba(0,0,0,0.5);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        z-index: 3;
         /* ‚ûú NEU: verschiebt das Chatfenster nach unten */
    transform: translateY(60px);
    }

    /* Chat scroll area */
    .chat-container {
        flex: 1;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        overflow-y: auto;
        scroll-behavior: smooth;
    }

    /* message row */
    .message {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        margin: 6px 0;
    }

    /* text bubble (base) */
    .text-bubble {
        padding: 10px 14px;
        border-radius: 16px;
        font-size: 0.95rem;
        line-height: 1.4;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        display: inline-block;
        word-break: break-word;
    }

    /* BOT */
    .bot-msg { justify-content: flex-start; }
    .bot-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%; /* kreisrund */
        object-fit: cover;
        flex-shrink: 0;
        box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    }
    .bot-bubble {
        background: linear-gradient(180deg,#ffffff,#f5f5f5);
        border-top-left-radius: 4px;
        max-width: 78%;
    }

    /* USER */
    .user-msg { justify-content: flex-end; }
    .user-bubble {
        background: linear-gradient(180deg,var(--primary),var(--primary-dark));
        color: white;
        border-top-right-radius: 4px;
        display: inline-block;
        width: auto; /* passt sich dem Text an */
        max-width: 75%;
    }

    /* Typing indicator bubble (looks like bot bubble with dots) */
    .typing-wrapper {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .typing-avatar { width: 40px; height:40px; border-radius:50%; object-fit:cover; opacity:0.9; }
    .typing-bubble {
        width: 64px;
        padding: 8px 10px;
        border-radius: 14px;
        background:#fff;
        display:flex;
        align-items:center;
        justify-content:center;
    }
    .dot {
        width:7px;height:7px;border-radius:50%;background:#777;margin:0 2px;opacity:0.3;
        animation: dot 1s infinite;
    }
    .dot:nth-child(2){animation-delay:0.15s}
    .dot:nth-child(3){animation-delay:0.3s}
    @keyframes dot {
        0%{opacity:0.25; transform: translateY(0);}
        50%{opacity:1; transform: translateY(-4px);}
        100%{opacity:0.25; transform: translateY(0);}
    }

    /* Input area */
    .input-container {
        display:flex;
        align-items:center;
        gap:10px;
        padding: 12px;
        border-top: 1px solid rgba(0,0,0,0.06);
        background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.95));
    }

    .input-container form { display:flex; flex:1; gap:10px; align-items:center; }

    input[type="text"]{
        flex:1;
        padding:11px 14px;
        border-radius:24px;
        border:1px solid rgba(0,0,0,0.12);
        outline:none;
        font-size:1rem;
        background: white;
    }
    input[type="text"]:disabled { background:#f3f3f3; color:#888; }

    button[type="submit"]{
        padding:10px 16px;
        border-radius:20px;
        border:none;
        background: var(--primary);
        color:white;
        font-weight:700;
        cursor:pointer;
    }
    button[type="submit"]:disabled{ opacity:0.6; cursor:default; }

    /* Start button inside bot bubble (chat-bubble style) */
    .start-btn {
        margin-top:10px;
        padding:8px 14px;
        border-radius:18px;
        border:none;
        background:#28a745;
        color:white;
        font-weight:700;
        cursor:pointer;
        display:inline-block;
    }
    .start-btn:active { transform: translateY(1px); }

    /* responsive tweaks */
    @media (max-width:420px){
        .chat-wrapper { height: 90vh; max-width: 380px; }
        #countdown { top: 12px; right: 12px; font-size:1rem; padding:8px 10px; }
    }
</style>
</head>
<body>

<!-- Countdown (outside the chat window, top-right on background) -->
<div id="countdown" aria-hidden="false">02:00</div>

<!-- Chat -->
<div class="chat-wrapper" role="application" aria-label="R√§tsel Chat">
    <div class="chat-container" id="chat" aria-live="polite">
        <!-- Welcome bot message with Start button inside bubble -->
        <div class="message bot-msg" id="welcomeMsg">
            <img src="2025-11-16_Avatar_Chatbot.png" alt="Bot" class="bot-avatar" />
            <div class="text-bubble bot-bubble" id="welcomeBubble">
                <div style="font-weight:600;margin-bottom:6px;">Willkommen, Abenteurer! üîç</div>
                <div style="margin-bottom:6px;">Ich bin der R√§tsel-Bot von Escape Game Castrop-Rauxel. Bist du bereit?</div>
                <div><strong>üëâ Antworte mit START</strong></div>
                <button class="start-btn" id="startBtn" aria-label="Start R√§tsel">START</button>
            </div>
        </div>
    </div>

    <div class="input-container">
        <form id="chatForm" autocomplete="off">
            <input id="userInput" type="text" placeholder="Deine Antwort..." aria-label="Antwort eingeben" />
            <button id="sendBtn" type="submit">Senden</button>
        </form>
    </div>
</div>

<!-- Audio element -->
<audio id="startSound" src="2025-11-09_Soundeffekt_Der_stille_Riese.mp3" preload="auto"></audio>

<script>
/* ---------- Elements & State ---------- */
const chat = document.getElementById('chat');
const chatForm = document.getElementById('chatForm');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const startBtn = document.getElementById('startBtn');
const welcomeMsg = document.getElementById('welcomeMsg');
const welcomeBubble = document.getElementById('welcomeBubble');
const countdownEl = document.getElementById('countdown');
const startSound = document.getElementById('startSound');

let gameState = 'WAIT_START'; // WAIT_START, WAIT_ANSWER, FINISHED, EXPIRED
let timer = null;
let remaining = 120; // seconds
let timerRunning = false;
let expiredHandled = false;

/* ---------- Helpers ---------- */
function escapeHtml(unsafe) {
    return unsafe.replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
}

function scrollToBottom() {
    chat.scrollTop = chat.scrollHeight;
}

/* ---------- Message functions ---------- */
function addBotMessage(html) {
    const wrapper = document.createElement('div');
    wrapper.className = 'message bot-msg';
    wrapper.innerHTML = `
        <img src="2025-11-16_Avatar_Chatbot.png" alt="Bot" class="bot-avatar">
        <div class="text-bubble bot-bubble">${html}</div>
    `;
    chat.appendChild(wrapper);
    scrollToBottom();
}

function addUserMessage(text) {
    const wrapper = document.createElement('div');
    wrapper.className = 'message user-msg';
    const bubble = document.createElement('div');
    bubble.className = 'text-bubble user-bubble';
    bubble.textContent = text;
    wrapper.appendChild(bubble);
    chat.appendChild(wrapper);
    scrollToBottom();
}

/* Typing indicator (returns a function to remove it) */
function showTypingIndicator() {
    const wrapper = document.createElement('div');
    wrapper.className = 'message bot-msg typing-wrapper';
    wrapper.innerHTML = `
        <img src="2025-11-16_Avatar_Chatbot.png" alt="Bot" class="typing-avatar">
        <div class="typing-bubble" role="status" aria-live="polite">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
    `;
    chat.appendChild(wrapper);
    scrollToBottom();
    return () => { wrapper.remove(); };
}

/* Bot replies with realistic typing delay based on text length */
function botReply(html) {
    const plain = html.replace(/<[^>]*>/g, '');
    const base = 700;
    const perChar = 25;
    const delay = Math.min(4500, base + perChar * plain.length);

    const removeTyping = showTypingIndicator();
    return new Promise(resolve => {
        setTimeout(() => {
            removeTyping();
            addBotMessage(html);
            resolve();
        }, delay);
    });
}

/* ---------- Timer ---------- */
function updateCountdownUI() {
    const mm = String(Math.floor(remaining/60)).padStart(2,'0');
    const ss = String(remaining%60).padStart(2,'0');
    countdownEl.textContent = `${mm}:${ss}`;
}

function startTimer() {
    if (timerRunning) return;
    timerRunning = true;
    remaining = 120;
    updateCountdownUI();
    timer = setInterval(() => {
        remaining--;
        updateCountdownUI();
        if (remaining <= 0) {
            clearInterval(timer);
            timerRunning = false;
            handleExpired();
        }
    }, 1000);
}

function stopTimer() {
    if (timer) {
        clearInterval(timer);
        timer = null;
    }
    timerRunning = false;
}

/* ---------- Expiry handling ---------- */
function handleExpired() {
    if (expiredHandled) return;
    expiredHandled = true;
    gameState = 'EXPIRED';
    userInput.disabled = true;
    sendBtn.disabled = true;
    // Provide graceful typing + message
    botReply('Deine R√§tselzeit ist leider abgelaufen. Wenn du unseren Gewinncode erhalten m√∂chtest, versuche es nochmal, indem du den Link ein weiteres Mal √∂ffnest.');
}

/* ---------- Start logic (Start-Button) ---------- */
startBtn.addEventListener('click', () => {
    // simulate user pressed START
    addUserMessage('START');

    // play sound (user-gesture -> allowed)
    startSound.currentTime = 0;
    startSound.play().catch(e => console.warn('Audio playback blocked:', e));

    // remove start button from welcome bubble
    startBtn.remove();

    // start timer
    startTimer();
    gameState = 'WAIT_ANSWER';

    // bot replies with typing animation
    botReply(`Sehr gut! üß≠<br>
        Du stehst auf dem Marktplatz von Castrop.<br>
        Ein alter Stadtf√ºhrer fl√ºstert dir zu:<br>
        <em>Ich sah das Dunkel, Tag f√ºr Tag,<br>wo keiner Sonne finden mag.<br>
        Die Stadt, sie wuchs durch meinen Flei√ü,<br>doch Ruhm vergeht ‚Äì wie Staub so leis.<br>
        Nun steh‚Äô ich still, aus Stahl gemacht,<br>bewacht die Stadt bei Tag und Nacht.</em><br>
        Wer bin ich? ü§î<br>
        (Antworte mit dem Ort!)<br>
        Wenn du einen Tipp ben√∂tigst schreibe <strong>HILFE</strong>.`);
});

/* ---------- Form submit handling ---------- */
chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    if (gameState === 'EXPIRED' || userInput.disabled) return;

    const raw = userInput.value.trim();
    if (!raw) return;
    userInput.value = '';
    addUserMessage(raw);

    handleInput(raw.toUpperCase());
});

/* ---------- Core game input handling ---------- */
function handleInput(input) {
    if (gameState === 'WAIT_START') {
        // If user typed START manually (button not used)
        if (input === 'START') {
            // behave same as startBtn click
            startBtn.click();
        } else {
            botReply('Bitte antworte mit <strong>START</strong>!').catch(()=>{});
        }
        return;
    }

    if (gameState === 'WAIT_ANSWER') {
        if (input === 'HILFE') {
            botReply('üí° Ein stilles Denkmal des Bergbaus. Du findest es, wenn du dorthin gehst, wo Castrops Vergangenheit in Stahl und Himmel √ºbergeht‚Ä¶');
            return;
        }

        // Accept several variations
        const normalized = input.replace(/\s+/g, '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toUpperCase();
        const correctVariants = ['ZECHEERIN','ZECHERIN','ZECHE ERIN','ZECHE ERIN','ZECH E RIN'.replace(/\s+/g,'')];

        if (normalized.includes('ZECH') && normalized.includes('ERIN') || normalized === 'ZECHEERIN' || normalized === 'ZECHEERIN'.toUpperCase()) {
            // correct
            stopTimer();
            botReply(`Ganz genau! üéâ<br>
                Der Geist der Zeche Erin wacht noch immer √ºber Castrop!<br><br>
                So √§hnlich l√§uft‚Äôs auch in unseren Outdoor Escape Games:<br>
                Du entdeckst spannende Orte in Castrop-Rauxel und l√∂st dabei R√§tsel mit mir ‚Äì dem R√§tsel-Bot! ü§ñüó∫Ô∏è<br><br>
                üëâ Neugierig? Dann schau vorbei auf <a href="https://www.escapegame-castrop-rauxel.de/" target="_blank">escapegame-castrop-rauxel.de</a>`)
            .then(()=> { gameState = 'FINISHED'; });
            return;
        }

        // wrong answer
        botReply('Denk nochmal nach! üòä');
    }
}

/* focus input */
userInput.focus();

/* initialize countdown UI */
updateCountdown();

/* keep countdown display correct on load */
function updateCountdown() {
    const mm = String(Math.floor(remaining/60)).padStart(2,'0');
    const ss = String(remaining%60).padStart(2,'0');
    countdownEl.textContent = `${mm}:${ss}`;
}
updateCountdown();

</script>
</body>
</html>

