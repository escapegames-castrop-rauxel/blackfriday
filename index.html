<script>
/* ---------- Elements & State ---------- */
const chat = document.getElementById('chat');
const chatForm = document.getElementById('chatForm');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const startBtn = document.getElementById('startBtn');
const welcomeMsg = document.getElementById('welcomeMsg');
const welcomeBubble = document.getElementById('welcomeBubble');
const countdownEl = document.getElementById('countdown');
const startSound = document.getElementById('startSound');

let gameState = 'WAIT_START';
let timer = null;
let remaining = 120;
let timerRunning = false;
let expiredHandled = false;

/* ---------- Helpers ---------- */
function escapeHtml(unsafe) {
    return unsafe.replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
}

function scrollToBottom() {
    chat.scrollTop = chat.scrollHeight;
}

/* ---------- Messages ---------- */
function addBotMessage(html) {
    const wrapper = document.createElement('div');
    wrapper.className = 'message bot-msg';
    wrapper.innerHTML = `
        <img src="2025-11-16_Avatar_Chatbot.png" alt="Bot" class="bot-avatar">
        <div class="text-bubble bot-bubble">${html}</div>
    `;
    chat.appendChild(wrapper);
    scrollToBottom();
}

function addUserMessage(text) {
    const wrapper = document.createElement('div');
    wrapper.className = 'message user-msg';
    const bubble = document.createElement('div');
    bubble.className = 'text-bubble user-bubble';
    bubble.textContent = text;
    wrapper.appendChild(bubble);
    chat.appendChild(wrapper);
    scrollToBottom();
}

/* Typing Indikator */
function showTypingIndicator() {
    const wrapper = document.createElement('div');
    wrapper.className = 'message bot-msg typing-wrapper';
    wrapper.innerHTML = `
        <img src="2025-11-16_Avatar_Chatbot.png" alt="Bot" class="typing-avatar">
        <div class="typing-bubble">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
    `;
    chat.appendChild(wrapper);
    scrollToBottom();
    return () => wrapper.remove();
}

function botReply(html) {
    const plain = html.replace(/<[^>]*>/g, '');
    const delay = Math.min(4500, 700 + 25 * plain.length);

    const removeTyping = showTypingIndicator();
    return new Promise(resolve => {
        setTimeout(() => {
            removeTyping();
            addBotMessage(html);
            resolve();
        }, delay);
    });
}

/* ---------- Timer ---------- */
function updateCountdownUI() {
    const mm = String(Math.floor(remaining/60)).padStart(2,'0');
    const ss = String(remaining%60).padStart(2,'0');
    countdownEl.textContent = `${mm}:${ss}`;
}

function startTimer() {
    if (timerRunning) return;
    timerRunning = true;
    remaining = 120;
    updateCountdownUI();
    timer = setInterval(() => {
        remaining--;
        updateCountdownUI();
        if (remaining <= 0) {
            clearInterval(timer);
            timerRunning = false;
            handleExpired();
        }
    }, 1000);
}

function stopTimer() {
    clearInterval(timer);
    timerRunning = false;
}

function handleExpired() {
    if (expiredHandled) return;
    expiredHandled = true;
    gameState = 'EXPIRED';
    userInput.disabled = true;
    sendBtn.disabled = true;

    botReply('Deine RÃ¤tselzeit ist leider abgelaufen. Wenn du unseren Gewinncode erhalten mÃ¶chtest, versuche es nochmal, indem du den Link ein weiteres Mal Ã¶ffnest.');
}

/* ---------- Start ---------- */
startBtn.addEventListener('click', () => {
    addUserMessage('START');

    startSound.currentTime = 0;
    startSound.play().catch(()=>{});

    startBtn.remove();

    startTimer();
    gameState = 'WAIT_ANSWER';

    botReply(`Sehr gut! ðŸ§­<br>
        Du stehst auf dem Marktplatz von Castrop...<br><br>
        Wer bin ich? ðŸ¤”<br>
        (Antworte mit dem Ort!)<br>
        Wenn du einen Tipp benÃ¶tigst, schreibe <strong>HILFE</strong>.`);
});

/* ---------- Fuzzy Matching ---------- */
function similarity(a, b) {
    let longer = a.length > b.length ? a : b;
    let shorter = a.length > b.length ? b : a;
    const longerLength = longer.length;
    if (longerLength === 0) return 1.0;
    const editDist = levenshtein(longer, shorter);
    return (longerLength - editDist) / longerLength;
}

function levenshtein(a, b) {
    const matrix = Array.from({ length: b.length + 1 }, (_, i) => [i]);
    for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

    for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
            matrix[i][j] = Math.min(
                matrix[i - 1][j] + 1,
                matrix[i][j - 1] + 1,
                matrix[i - 1][j - 1] + (a[j - 1] === b[i - 1] ? 0 : 1)
            );
        }
    }
    return matrix[b.length][a.length];
}

/* ---------- Input Handling ---------- */
chatForm.addEventListener('submit', e => {
    e.preventDefault();
    if (userInput.disabled || gameState === 'EXPIRED') return;

    const raw = userInput.value.trim();
    if (!raw) return;
    userInput.value = '';
    addUserMessage(raw);

    handleInput(raw.toUpperCase());
});

function handleInput(input) {

    if (gameState === 'WAIT_START') {
        if (input === 'START') startBtn.click();
        else botReply('Bitte antworte mit <strong>START</strong>!');
        return;
    }

    if (gameState === 'WAIT_ANSWER') {

        if (input === 'HILFE') {
            botReply('ðŸ’¡ Ein stilles Denkmal des Bergbaus...');
            return;
        }

        const normalized = input
            .replace(/\s+/g, '')
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toUpperCase();

        const solutions = [
            "ZECHEERIN",
            "ERIN",
            "FOERDERTURMERIN",
            "ERINERFOERDERTURM",
            "ERINERZECHE"
        ];

        let isCorrect = false;
        for (const sol of solutions) {
            if (similarity(normalized, sol) >= 0.8) {
                isCorrect = true;
                break;
            }
        }

        if (isCorrect) {
            stopTimer();
            gameState = 'FINISHED';
            botReply(`Ganz genau! ðŸŽ‰<br>
                Der Geist der Zeche Erin wacht noch immer Ã¼ber Castrop!<br><br>
                ðŸ‘‰ escapegame-castrop-rauxel.de`);
            return;
        }

        botReply('Denk nochmal nach! ðŸ˜Š');
    }
}

userInput.focus();
updateCountdownUI();
</script>
