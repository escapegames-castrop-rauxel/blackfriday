<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Escape Game Castrop-Rauxel R√§tsel-Bot</title>
<style>
:root{
    --primary: #007bff;
    --primary-dark: #0056b3;
    --accent: #f7b731;
}

html,body{height:100%;margin:0;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background-color:#111;}

body {
    display: flex;
    justify-content: center;
    align-items: center;
    background: url('2025-11-09_Hintergrund_Webchat_Der_stille_Riese.png') no-repeat center center fixed;
    background-size: cover;
    height: 100vh;
    margin: 0;
}

#countdown {
    position: absolute;
    top: 18px;
    right: 18px;
    background: rgba(0,0,0,0.55);
    padding: 10px 14px;
    border-radius: 10px;
    color: var(--accent);
    font-size: 1.1rem;
    font-weight: 700;
    border: 2px solid rgba(247,183,49,0.22);
    text-shadow: 0 0 6px rgba(0,0,0,0.6);
    z-index: 2;
    font-family: 'Courier New', monospace;
}

.chat-wrapper {
    width: 95%;
    max-width: 420px;
    height: 78vh;
    max-height: 760px;
    background: rgba(255,255,255,0.48);
    backdrop-filter: blur(6px);
    border-radius: 14px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
    z-index: 3;
    transform: translateY(30px);
}

.chat-container {
    flex: 1;
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    overflow-y: auto;
    scroll-behavior: smooth;
}

.message { display:flex; align-items:flex-end; gap:10px; margin:6px 0; }

.text-bubble {
    padding: 10px 14px;
    border-radius: 16px;
    font-size: 0.95rem;
    line-height: 1.4;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    word-break: break-word;
    display:inline-block;
}

.bot-msg { justify-content: flex-start; }
.bot-avatar { width: 40px; height:40px; border-radius:50%; object-fit:cover; flex-shrink:0; box-shadow:0 1px 4px rgba(0,0,0,0.25); }
.bot-bubble { background: linear-gradient(180deg,#ffffff,#f5f5f5); border-top-left-radius:4px; max-width:78%; }

.user-msg { justify-content: flex-end; }
.user-bubble { background: linear-gradient(180deg,var(--primary),var(--primary-dark)); color:white; border-top-right-radius:4px; max-width:75%; }

.typing-wrapper { display:flex; gap:10px; align-items:center; }
.typing-avatar { width:40px;height:40px;border-radius:50%;object-fit:cover; opacity:0.9; }
.typing-bubble { width:64px; padding:8px 10px; border-radius:14px; background:#fff; display:flex; align-items:center; justify-content:center; }
.dot { width:7px;height:7px;border-radius:50%;background:#777;margin:0 2px;opacity:0.3; animation: dot 1s infinite; }
.dot:nth-child(2){animation-delay:0.15s;}
.dot:nth-child(3){animation-delay:0.3s;}
@keyframes dot { 0%{opacity:0.25;transform:translateY(0);} 50%{opacity:1;transform:translateY(-4px);} 100%{opacity:0.25;transform:translateY(0);} }

.input-container {
    display:flex;
    align-items:center;
    gap:10px;
    padding:12px;
    border-top:1px solid rgba(0,0,0,0.06);
    background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.95));
}

.input-container form { display:flex; flex:1; gap:10px; align-items:center; }
input[type="text"] { flex:1; padding:11px 14px; border-radius:24px; border:1px solid rgba(0,0,0,0.12); outline:none; font-size:1rem; background:white; }
input[type="text"]:disabled { background:#f3f3f3; color:#888; }
button[type="submit"]{ padding:10px 16px; border-radius:20px; border:none; background:var(--primary); color:white; font-weight:700; cursor:pointer; }
button[type="submit"]:disabled{ opacity:0.6; cursor:default; }

.start-btn { margin-top:10px; padding:8px 14px; border-radius:18px; border:none; background:#28a745; color:white; font-weight:700; cursor:pointer; display:inline-block; }
.start-btn:active { transform: translateY(1px); }

@media(max-width:420px){ .chat-wrapper{height:90vh;max-width:380px;} #countdown{top:12px;right:12px;font-size:1rem;padding:8px 10px;} }

</style>
</head>
<body>

<div id="countdown">02:00</div>

<div class="chat-wrapper" role="application" aria-label="R√§tsel Chat">
    <div class="chat-container" id="chat" aria-live="polite">
        <div class="message bot-msg" id="welcomeMsg">
            <img src="2025-11-16_Avatar_Chatbot.png" alt="Bot" class="bot-avatar">
            <div class="text-bubble bot-bubble" id="welcomeBubble">
                <div style="font-weight:600;margin-bottom:6px;">Willkommen, Abenteurer! üîç</div>
                <div style="margin-bottom:6px;">Ich bin der R√§tsel-Bot von Escape Game Castrop-Rauxel. Bist du bereit?</div>
                <div><strong>üëâ Antworte mit START</strong></div>
                <button class="start-btn" id="startBtn">START</button>
            </div>
        </div>
    </div>

    <div class="input-container">
        <form id="chatForm" autocomplete="off">
            <input id="userInput" type="text" placeholder="Deine Antwort...">
            <button id="sendBtn" type="submit">Senden</button>
        </form>
    </div>
</div>

<audio id="startSound" src="2025-11-09_Soundeffekt_Der_stille_Riese.mp3" preload="auto" loop></audio>

<script>
const chat = document.getElementById('chat');
const chatForm = document.getElementById('chatForm');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const startBtn = document.getElementById('startBtn');
const countdownEl = document.getElementById('countdown');
const startSound = document.getElementById('startSound');

let gameState = 'WAIT_START';
let timer = null;
let remaining = 120;
let timerRunning = false;
let expiredHandled = false;

/* Helpers */
function scrollToBottom(){ chat.scrollTop = chat.scrollHeight; }
function addBotMessage(html){
    const wrapper=document.createElement('div');
    wrapper.className='message bot-msg';
    wrapper.innerHTML=`<img src="2025-11-16_Avatar_Chatbot.png" alt="Bot" class="bot-avatar"><div class="text-bubble bot-bubble">${html}</div>`;
    chat.appendChild(wrapper);
    scrollToBottom();
}
function addUserMessage(text){
    const wrapper=document.createElement('div');
    wrapper.className='message user-msg';
    const bubble=document.createElement('div');
    bubble.className='text-bubble user-bubble';
    bubble.textContent=text;
    wrapper.appendChild(bubble);
    chat.appendChild(wrapper);
    scrollToBottom();
}
function showTypingIndicator(){
    const wrapper=document.createElement('div');
    wrapper.className='message bot-msg typing-wrapper';
    wrapper.innerHTML=`<img src="2025-11-16_Avatar_Chatbot.png" alt="Bot" class="typing-avatar"><div class="typing-bubble" role="status" aria-live="polite"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
    chat.appendChild(wrapper);
    scrollToBottom();
    return ()=>{ wrapper.remove(); };
}
function botReply(html){
    const plain=html.replace(/<[^>]*>/g,'');
    const delay=Math.min(4500,700 + 25*plain.length);
    const removeTyping=showTypingIndicator();
    return new Promise(resolve=>{
        setTimeout(()=>{
            removeTyping();
            addBotMessage(html);
            resolve();
        },delay);
    });
}

/* Timer */
function updateCountdownUI(){
    const mm=String(Math.floor(remaining/60)).padStart(2,'0');
    const ss=String(remaining%60).padStart(2,'0');
    countdownEl.textContent=`${mm}:${ss}`;
}
function startTimer(){
    if(timerRunning) return;
    timerRunning=true;
    remaining=120;
    updateCountdownUI();
    timer=setInterval(()=>{
        remaining--;
        updateCountdownUI();
        if(remaining<=0){
            clearInterval(timer);
            timerRunning=false;
            handleExpired();
        }
    },1000);
}
function stopTimer(){
    if(timer){ clearInterval(timer); timer=null; }
    timerRunning=false;
}

/* Expiry */
function handleExpired(){
    if(expiredHandled) return;
    expiredHandled=true;
    gameState='EXPIRED';
    userInput.disabled=true;
    sendBtn.disabled=true;
    botReply('Deine R√§tselzeit ist leider abgelaufen. Versuche es erneut, indem du den Link noch einmal √∂ffnest.');
}

/* Start Button */
startBtn.addEventListener('click',()=>{
    addUserMessage('START');
    startSound.currentTime=0;
    startSound.play().catch(()=>{});
    startBtn.remove();
    startTimer();
    gameState='WAIT_ANSWER';
    botReply(`Sehr gut! üß≠<br>Du stehst auf dem Marktplatz von Castrop.<br>Ein alter Stadtf√ºhrer fl√ºstert dir zu:<br><em>Ich sah das Dunkel, Tag f√ºr Tag,<br>wo keiner Sonne finden mag.<br>Die Stadt, sie wuchs durch meinen Flei√ü,<br>doch Ruhm vergeht ‚Äì wie Staub so leis.<br>Nun steh‚Äô ich still, aus Stahl gemacht,<br>bewacht die Stadt bei Tag und Nacht.</em><br>Wer bin ich? ü§î<br>(Antworte mit dem Ort!)<br>Wenn du einen Tipp ben√∂tigst schreibe <strong>HILFE</strong>.`);
});

/* Fuzzy Matching */
function similarity(a,b){
    let longer=a.length>b.length?a:b;
    let shorter=a.length>b.length?b:a;
    const longerLength=longer.length;
    if(longerLength===0) return 1.0;
    const editDist=levenshtein(longer,shorter);
    return (longerLength-editDist)/longerLength;
}
function levenshtein(a,b){
    const matrix=Array.from({length:b.length+1},(_,i)=>[i]);
    for(let j=0;j<=a.length;j++){ matrix[0][j]=j; }
    for(let i=1;i<=b.length;i++){
        for(let j=1;j<=a.length;j++){
            matrix[i][j]=Math.min(
                matrix[i-1][j]+1,
                matrix[i][j-1]+1,
                matrix[i-1][j-1]+(a[j-1]===b[i-1]?0:1)
            );
        }
    }
    return matrix[b.length][a.length];
}

/* Form submit */
chatForm.addEventListener('submit',(e)=>{
    e.preventDefault();
    if(gameState==='EXPIRED'||userInput.disabled) return;
    const raw=userInput.value.trim();
    if(!raw) return;
    userInput.value='';
    addUserMessage(raw);
    handleInput(raw);
});

/* Core Input Handling */
function handleInput(input){
    input=input.toUpperCase().replace(/\s+/g,'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    if(gameState==='WAIT_START'){
        if(input==='START'){ startBtn.click(); return; }
        botReply('Bitte antworte mit <strong>START</strong>!');
        return;
    }
    if(gameState==='WAIT_ANSWER'){
        if(input==='HILFE'){
            botReply('üí° Ein stilles Denkmal des Bergbaus. Du findest es, wenn du dorthin gehst, wo Castrops Vergangenheit in Stahl und Himmel √ºbergeht‚Ä¶');
            return;
        }
        const solutions=["ZECHEERIN","ERIN","FOERDERTURMERIN","ERINERFOERDERTURM","ERINERZECHE"];
        let isCorrect=false;
        for(const sol of solutions){ if(similarity(input,sol)>=0.8){ isCorrect=true; break; } }
        if(isCorrect){
            stopTimer();
            botReply(`Ganz genau! üéâ<br>
Der Geist der Zeche Erin wacht noch immer √ºber Castrop!<br><br>
Du entdeckst spannende Orte in Castrop-Rauxel und l√∂st R√§tsel mit mir ‚Äì dem R√§tsel-Bot! ü§ñüó∫Ô∏è<br><br>
üëâ Schau vorbei:<br><a href="https://www.escapegame-castrop-rauxel.de/" target="_blank">escapegame-castrop-rauxel.de</a>. <br><br>üéÑ Adventsspecial: W√§hrend der ersten Adventwoche schenken wir dir <strong>5‚ÄØ‚Ç¨ Cashback</strong>!<br>Trage einfach in den Bestellhinweisen den Code <strong>Schneekugel2025</strong> ein ‚Äì wir √ºberweisen dir den Betrag innerhalb von 3‚ÄØTagen nach Bestelleingang direkt auf dein Konto.<br><br>P.S.: Bei uns kann man auch Gutscheine bestellen. Ein ideales Weihnachtsgeschenk f√ºr jeden R√§tselliebhaber.`).then(()=>{ gameState='FINISHED'; });
            return;
        }
        botReply('Knapp daneben ist auch vorbei! üòä Hast du dich vielleicht vertippt?<br>Dann gib deine L√∂sung ohne Tippfehler erneut ein.<br>Solltest du nicht mehr weiter wissen, wende dich mit <strong>HILFE</strong> an unseren Bot und er wird dir einen Hinweis geben.üïµÔ∏è‚Äç‚ôÇÔ∏è');
    }
}

/* Focus Input & Countdown */
userInput.focus();
updateCountdownUI();
</script>

</body>
</html>





